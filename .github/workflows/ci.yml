name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v5
      - run: uvx ruff check .

  format:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v5
      - run: uvx ruff format --check .

  typecheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v5
      - run: uv run --group dev --extra torch --extra jax ty check

  tests-core:
    name: Tests Core (py3.12, locked)
    runs-on: ubuntu-latest
    env:
      UV_PYTHON: "3.12"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - uses: astral-sh/setup-uv@v5
      - run: uv sync --group dev --all-extras --frozen
      - run: uv run pytest -q tests/test_anny.py tests/test_flame.py tests/test_mhr.py tests/test_skel.py tests/test_smpl.py tests/test_smplx.py tests/test_compile.py

  tests-version-smoke:
    name: Tests Version Smoke (py${{ matrix.python-version }}, ${{ matrix.resolution }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - python-version: "3.11"
            resolution: locked
          - python-version: "3.12"
            resolution: locked
          - python-version: "3.13"
            resolution: locked
          - python-version: "3.11"
            resolution: lowest-direct
    env:
      UV_PYTHON: ${{ matrix.python-version }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - uses: astral-sh/setup-uv@v5
      - name: Sync environment
        run: |
          if [ "${{ matrix.resolution }}" = "lowest-direct" ]; then
            uv sync --group dev --all-extras --resolution lowest-direct
          else
            uv sync --group dev --all-extras --frozen
          fi
      - run: uv run pytest -q tests/test_version_smoke.py
